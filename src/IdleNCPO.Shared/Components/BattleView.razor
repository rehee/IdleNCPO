@using IdleNCPO.Core.Services
@using IdleNCPO.Core.DTOs
@using IdleNCPO.Core.Profiles

<div class="card battle-view">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5>
      @if (IsPlayingBack)
      {
        <span class="badge bg-warning me-2">回放中</span>
      }
      战斗 - @GetMapName(DisplayBattle?.Map.ProfileKey ?? EnumMap.NotSpecified)
    </h5>
    <div>
      <span class="badge bg-info me-2">Tick: @(DisplayBattle?.CurrentTick ?? 0)</span>
      @if (BattleResult != null)
      {
        <span class="badge bg-secondary">耗时: @BattleResult.DurationSeconds.ToString("F2")秒</span>
      }
    </div>
  </div>
  <div class="card-body">
    @if (DisplayBattle != null)
    {
      @* 2D Map View *@
      <div class="mb-3">
        <MapView2D Battle="@DisplayBattle" />
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <h6>玩家</h6>
          @if (DisplayBattle.Map.Player != null)
          {
            <div class="progress mb-2">
              <div class="progress-bar bg-danger" role="progressbar" 
                   style="width: @(DisplayBattle.Map.Player.MaxHealth > 0 ? (DisplayBattle.Map.Player.CurrentHealth * 100 / DisplayBattle.Map.Player.MaxHealth) : 0)%">
                HP: @DisplayBattle.Map.Player.CurrentHealth / @DisplayBattle.Map.Player.MaxHealth
              </div>
            </div>
            <div class="progress mb-2">
              <div class="progress-bar bg-primary" role="progressbar" 
                   style="width: @(DisplayBattle.Map.Player.MaxMana > 0 ? (DisplayBattle.Map.Player.CurrentMana * 100 / DisplayBattle.Map.Player.MaxMana) : 0)%">
                MP: @DisplayBattle.Map.Player.CurrentMana / @DisplayBattle.Map.Player.MaxMana
              </div>
            </div>
          }
        </div>
        <div class="col-md-6">
          <h6>怪物 (波次 @DisplayBattle.Map.CurrentWave/@DisplayBattle.Map.TotalWaves)</h6>
          @foreach (var monster in DisplayBattle.Map.GetAliveMonsters().Take(5))
          {
            <div class="monster-hp mb-1">
              <small>@monster.Name Lv.@monster.Level</small>
              <div class="progress" style="height: 10px;">
                <div class="progress-bar bg-warning" role="progressbar" 
                     style="width: @(monster.MaxHealth > 0 ? (monster.CurrentHealth * 100 / monster.MaxHealth) : 0)%">
                </div>
              </div>
            </div>
          }
          @if (DisplayBattle.Map.GetAliveMonsters().Count() > 5)
          {
            <small class="text-muted">还有 @(DisplayBattle.Map.GetAliveMonsters().Count() - 5) 个怪物...</small>
          }
        </div>
      </div>

      @* Battle Controls *@
      @if (!DisplayBattle.IsFinished && !IsPlayingBack)
      {
        <div class="mt-3 text-center">
          <button class="btn btn-warning me-2" @onclick="InstantBattle" disabled="@isProcessing">
            @if (isProcessing)
            {
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            }
            即时战斗
          </button>
          <button class="btn btn-primary me-2" @onclick="ProcessTicks" disabled="@isProcessing">
            战斗 (10 Ticks)
          </button>
          <button class="btn btn-success" @onclick="AutoBattle" disabled="@isProcessing">
            自动战斗
          </button>
        </div>
      }
      else if (IsPlayingBack)
      {
        <div class="mt-3 text-center">
          <button class="btn btn-danger" @onclick="StopPlayback">
            停止回放
          </button>
        </div>
      }
      else
      {
        @* Battle Result Display *@
        <div class="mt-3 text-center">
          <div class="alert @(DisplayBattle.IsVictory ? "alert-success" : "alert-danger")">
            <h5>@(DisplayBattle.IsVictory ? "胜利!" : "失败...")</h5>
            @if (BattleResult != null)
            {
              <p>
                <strong>战斗耗时:</strong> @BattleResult.DurationSeconds.ToString("F2") 秒 
                (@BattleResult.TotalTicks ticks)
              </p>
              <p><strong>地图:</strong> @GetMapName(BattleResult.MapKey)</p>
            }
            @if (DisplayBattle.IsVictory)
            {
              <p><strong>获得经验:</strong> @DisplayBattle.ExperienceGained</p>
              @if (DisplayBattle.ItemsDropped.Count > 0)
              {
                <p><strong>获得物品:</strong> @DisplayBattle.ItemsDropped.Count 件</p>
              }
            }
          </div>
          <div class="btn-group">
            @if (BattleResult != null)
            {
              <button class="btn btn-info" @onclick="StartPlayback" disabled="@IsPlayingBack">
                <i class="bi bi-play-fill"></i> 播放回放
              </button>
            }
            <button class="btn btn-primary" @onclick="CompleteBattle">返回</button>
          </div>
        </div>
      }
    }
  </div>
</div>

@code {
  [Parameter]
  public BattleService? Battle { get; set; }

  [Parameter]
  public ProfileService? ProfileService { get; set; }

  [Parameter]
  public EventCallback<BattleService> OnBattleComplete { get; set; }

  private bool isProcessing = false;
  private BattleResultDTO? BattleResult;
  private BattlePlaybackService? _playbackService;
  private BattleService? _playbackBattle;
  private bool IsPlayingBack => _playbackService?.IsPlaying ?? false;

  /// <summary>
  /// The battle to display (either current battle or playback)
  /// </summary>
  private BattleService? DisplayBattle => _playbackBattle ?? Battle;

  protected override void OnInitialized()
  {
    if (ProfileService != null)
    {
      _playbackService = new BattlePlaybackService(ProfileService);
      _playbackService.OnTickProcessed += HandlePlaybackTick;
      _playbackService.OnPlaybackComplete += HandlePlaybackComplete;
    }
  }

  private string GetMapName(EnumMap map)
  {
    return map switch
    {
      EnumMap.StarterVillage => "新手村",
      EnumMap.DarkCave => "黑暗洞窟",
      EnumMap.ForestPath => "森林小径",
      EnumMap.GoblinCamp => "哥布林营地",
      EnumMap.UndeadCrypt => "亡灵地穴",
      _ => map.ToString()
    };
  }

  /// <summary>
  /// Instant battle - completes immediately and saves result
  /// </summary>
  private void InstantBattle()
  {
    if (Battle == null) return;
    isProcessing = true;
    
    // Run battle to completion instantly
    Battle.RunToCompletion();
    
    // Save the battle result for replay
    BattleResult = Battle.GetBattleResult();
    
    isProcessing = false;
    StateHasChanged();
  }

  private void ProcessTicks()
  {
    if (Battle == null) return;
    isProcessing = true;
    
    for (int i = 0; i < 10 && !Battle.IsFinished; i++)
    {
      Battle.ProcessTick();
    }
    
    // If battle finished, save result
    if (Battle.IsFinished && BattleResult == null)
    {
      BattleResult = Battle.GetBattleResult();
    }
    
    isProcessing = false;
    StateHasChanged();
  }

  private void AutoBattle()
  {
    if (Battle == null) return;
    Battle.RunToCompletion();
    
    // Save the battle result
    BattleResult = Battle.GetBattleResult();
    
    StateHasChanged();
  }

  /// <summary>
  /// Start playback of the battle result
  /// </summary>
  private async Task StartPlayback()
  {
    if (BattleResult == null || _playbackService == null) return;
    
    await _playbackService.StartPlaybackAsync(BattleResult);
  }

  /// <summary>
  /// Stop the current playback
  /// </summary>
  private async Task StopPlayback()
  {
    if (_playbackService == null) return;
    await _playbackService.StopPlaybackAsync();
    _playbackBattle = null;
    StateHasChanged();
  }

  private void HandlePlaybackTick(BattleService battle)
  {
    _playbackBattle = battle;
    InvokeAsync(StateHasChanged);
  }

  private void HandlePlaybackComplete(BattleService battle)
  {
    _playbackBattle = null;
    InvokeAsync(StateHasChanged);
  }

  private async Task CompleteBattle()
  {
    // Stop any playback first
    if (_playbackService != null)
    {
      await _playbackService.StopPlaybackAsync();
    }
    
    if (Battle != null)
    {
      await OnBattleComplete.InvokeAsync(Battle);
    }
  }

  public void Dispose()
  {
    if (_playbackService != null)
    {
      _playbackService.OnTickProcessed -= HandlePlaybackTick;
      _playbackService.OnPlaybackComplete -= HandlePlaybackComplete;
    }
  }
}
